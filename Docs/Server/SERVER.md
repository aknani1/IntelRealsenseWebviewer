
# Server-Side Documentation

This document describes the server code for the Intel RealSense Web Viewer. The Flask backend is responsible for interfacing with the RealSense camera, processing frames, and exposing REST endpoints and WebSocket events used by the Angular client.

It is structured to complement the client-side documentation. For example, the REST endpoints documented in [API Documentation](API.md) and the WebSocket events detailed in [WEBSOCKET.md] are implemented on this side.

---

## Project Structure

```
server/
├── app/
│   ├── __init__.py         # Application and extension initialization (Flask, CORS, SocketIO)
│   ├── camera_manager.py   # Manages the RealSense pipeline, configuration, sensor caching, and frame generation
│   ├── config.py           # Default configuration values (resolution, FPS, exposure)
│   ├── metadata_helpers.py # Utilities for gathering and formatting metadata from frames
│   └── routes.py           # REST API endpoints and Socket.IO event handlers
├── run.py                  # Server entry point for starting Flask
└── requirements.txt        # Python dependencies required by the server
```

---

## Key Modules

### 1. app/__init__.py

- Initializes the Flask application.
- Sets up CORS (with wildcard origins or specific settings) so that the Angular client can make API and WebSocket requests.
- Initializes the SocketIO extension for real-time communication.
- **Client Connection Note:**  
  The client (Angular) uses REST endpoints and WebSocket events configured here. For example, SocketIO is set up with CORS allowed so that events (such as `video_frame` or `device_status`) reach the client.

---


### 2. app/camera_manager.py

- **Purpose:**  
  Wraps the RealSense SDK functionalities and manages the camera's state and streaming process.
  
- **Key Responsibilities:**
  - **Pipeline Management:**  
    The `configure_pipeline()` method configures and starts the RealSense pipeline based on current settings (resolution, FPS, etc.) defined in `config.py`.
  - **Frame Processing:**  
    The `generate_frames()` method generates frame data (including an optional 3D view) and applies overlays if metadata toggles are enabled.
  - **Sensor Caching and Exposure:**  
    Caches references for the RGB and depth sensors. Provides methods like `set_exposure()` and `update_resolution_and_fps()` to allow live camera configuration.
  - **Utility Methods:**  
    Methods such as `get_device_info()` provide basic hardware details, which can be consumed by the client to display camera information.
  
- **Client Connection Note:**  
  The data generated by this module is emitted through SocketIO as `video_frame` events. The Angular client listens for these events to update the displayed video streams.

---

### 3. app/config.py

- Contains a dictionary of default settings for camera operation.
- **Default Settings Include:**
  - Resolution (e.g., 640x360 for color and depth)
  - Frame Rate (e.g., 30 FPS)
  - Exposure values
- **Example:**
  ```python
  DEFAULTS = {
      "color": {
          "width": 640,
          "height": 360,
          "fps": 30,
          "exposure": 300
      },
      "depth": {
          "width": 640,
          "height": 360,
          "fps": 30,
          "exposure": 300
      }
  }
  ```
- **Client Connection Note:**  
  API endpoints allow the client to update these settings in real time (for instance, via the `/api/configure` endpoint).

---

### 4. app/routes.py

- Defines REST API endpoints for interacting with the camera and applying settings.
- **Examples of Endpoints:**
  - **GET `/api/camera_info`:**  
    Returns camera hardware information (using `get_device_info()`).
  - **POST `/api/configure`:**  
    Accepts JSON data to update camera resolution and frame rate.
  - **POST `/api/exposure`:**  
    Adjusts exposure for either the depth or RGB camera.
  - **POST `/api/set_metadata`:**  
    Toggles the overlay of metadata on live streams.
  - **POST `/api/hard_reset`:**  
    Performs a hardware reset on the camera.
  
- **WebSocket Declarations:**  
  Within the same module or through SocketIO event handlers, events such as `connect`, `start_stream`, `stop_stream`, and `disconnect` are declared.
  
- **Client Connection Note:**  
  These endpoints are consumed by the Angular HttpConfigService and the WebSocketService. They let the client update configurations and control when the stream starts or stops. For instance, when a user changes settings in the Angular app, the client sends a POST request to `/api/configure`, and the server updates the pipeline accordingly.

---

## Running the Server

To run the server on all interfaces (so the Angular client on another machine can communicate correctly), use:
```bash
python run.py --host 0.0.0.0 --port 5000
```
(Alternatively, ensure that your run.py includes `app.run(host='0.0.0.0', port=5000, debug=True)`).

**Firewall and CORS Considerations:**  
- Make sure your firewall opens port 5000.
- CORS is set to allow requests from all origins or configured specifically so that the Angular client (running on port 4200 or built for production) can connect.

---

## How Server and Client Interact

- **REST API:**  
  The Angular client makes HTTP requests to endpoints (e.g., `/api/configure`, `/api/exposure`) to change camera settings. Responses provide confirmation messages and updated status.
  
- **WebSocket Events:**  
  The Flask server uses SocketIO to push live streams. For example, after starting the stream (triggered by `start_stream` from the client), the server continuously emits `video_frame` events containing:
  - Base64-encoded images (color and depth)
  - Optionally, a 3D visualization (if enabled)
  - Metadata such as FPS, resolution, etc.
  
  The client listens for these events (using the WebSocketService) and updates the view accordingly.

- **Device Information:**  
  When the client connects, it receives the device status (via `device_status` events) and information returned through `/api/camera_info`, which the Angular components display in the sidebar.

---

## Conclusion

This server-side architecture enables real-time communication with the Intel RealSense camera, transforms raw data into web-friendly formats, and exposes configuration controls to the client. By maintaining a clear contract via REST endpoints and WebSocket events (as detailed in the API and WEBSOCKET documentation), the client and server work together seamlessly to provide a robust, interactive camera viewer application.

–––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––
```
